<?php
	class almyDb
	{
		private static $serveur='mysql:host=127.0.0.1';
                private static $bdd='dbname=almy';   		
                private static $user='almy';    		
                private static $mdp='123456';
		private static $PDO;
		private static $almyDb=null;
	
		private function __construct()
		{
			almyDb::$PDO = new PDO(almyDb::$serveur.';'.almyDb::$bdd, almyDb::$user, almyDb::$mdp); 
			almyDb::$PDO->query("SET CHARACTER SET utf8");
		}
		
		public function _destruct()
		{
			almyDb::$PDO = null;
		}
	
		public static function getDB()
		{
			if(almyDb::$almyDb==null){
				almyDb::$almyDb= new almyDb();
			}
			return almyDb::$almyDb;  
		}
	
		public function execSQL($sql)
		{
			return almyDb::$PDO->query($sql);
		}
      
      /* 
      ** Gestion des catégories
      */
      public function getListeCategorie($search = null) {
			if($search == null) {
				$sql = "SELECT * FROM category ORDER BY name ASC";
				$sth = almyDb::$PDO->prepare($sql);
				$sth->execute();
			}
			else {
				$search = "%".$search."%";
				$sql = "SELECT * FROM category WHERE name LIKE :search ORDER BY name ASC";
				$sth = almyDb::$PDO->prepare($sql);
				$sth->bindParam(':search', $search, PDO::PARAM_STR);
				$sth->execute();
			}
         return $sth->fetchAll();
      }
      public function getListeIdCategorie() {
         $sql = "SELECT id FROM category ORDER BY name ASC";
		 $sth = almyDb::$PDO->prepare($sql);
		 $sth->execute();
		 $list =  $sth->fetchAll();
		 
         $retour = array();
         foreach ($list as $temp) {
             $retour[] = $list['id'];
         }
         return $retour;
      }
      public function getListeIdCategorieImg($idImg) {
         $retour = array();
         $list = $this->getListeCategorieImg($idImg);
         foreach ($list as $temp) {
             if($temp['is']===true) 
                $retour[] = $temp['id'];
         }
         return $retour;
      }
      public function getListeCategorieImg($idImg) {
		 $retour = array();
                 $list = $this->getListeCategorie();
		 foreach($list as $cat) {
			 $sql = "SELECT * FROM catimg WHERE id_img=:idImg AND id_cat=:idCat;";
			 
			 $sth = almyDb::$PDO->prepare($sql);
			 $sth->bindParam(':idImg', $idImg, PDO::PARAM_INT);
			 $sth->bindParam(':idCat', $cat['id'], PDO::PARAM_INT);
			 $sth->execute();
			 
			 $retour[count($retour)] = array("id" => $cat['id'], "name" => $cat['name'], "is" => (($sth->rowCount() != 0)?true:false));
		 }
         return $retour;
      }
      public function isCategorie($name) {
         $sql = "SELECT * FROM category WHERE name=:name;";
		 $sth = almyDb::$PDO->prepare($sql);
		 $sth->bindParam(':name', $name, PDO::PARAM_STR);
		 $sth->execute();
         if($sth->rowCount() == 0) {
            return false;
         }
         else {
            return true;
         }
      }
      public function addCategorie($name) {
         if(!$this->isCategorie($name)) {
            $sql = "INSERT INTO category (id, name) VALUES (NULL, :name);";
			$sth = almyDb::$PDO->prepare($sql);
			$sth->bindParam(':name', $name, PDO::PARAM_STR);
			$sth->execute();
            return true;
         }
         else {
            return false;
         }
      }
      public function updateCategorie($id, $name) {
         $sql = "SELECT * FROM category WHERE id=:id;";
		 $sth = almyDb::$PDO->prepare($sql);
		 $sth->bindParam(':id', $id, PDO::PARAM_INT);
		 $sth->execute();
         if(($sth->rowCount() == 1) && (!$this->isCategorie($name))) {
            $sql = "UPDATE category SET name = :name WHERE id =:id;";
			$sth = almyDb::$PDO->prepare($sql);
			$sth->bindParam(':id', $id, PDO::PARAM_INT);
			$sth->bindParam(':name', $name, PDO::PARAM_STR);
			$sth->execute();
            return true;
         }
         else {
            return false;
         }
      }
      public function deleteCategorie($id) {
         $sql = "DELETE FROM category WHERE id = :id;";
		 $sth = almyDb::$PDO->prepare($sql);
		 $sth->bindParam(':id', $id, PDO::PARAM_INT);
		 $sth->execute();
         if($sth->rowCount() == 1) {
            return true;
         }
         else {
            return false;
         }
      }
  
     /*
     ** Gestion des images
     */
      public function getImage($id) {
         $sql = "SELECT * FROM image WHERE id=:id;";
		 $sth = almyDb::$PDO->prepare($sql);
		 $sth->bindParam(':id', $id, PDO::PARAM_INT);
		 $sth->execute();
         return $sth->fetch();
      }
      public function getImageByLink($url) {
         $sql = "SELECT * FROM image WHERE url=:url OR url_min=:urlMin;";
		 $sth = almyDb::$PDO->prepare($sql);
		 $sth->bindParam(':url', $url, PDO::PARAM_STR);
		 $sth->bindParam(':urlMin', $url, PDO::PARAM_STR);
		 $sth->execute();
         return $sth->fetch();
      }
      public function getListeSearchImage($search) {
		 $search = "%".$search."%";
         $sql = "SELECT * FROM image WHERE title LIKE :searchT OR descr LIKE :searchD ORDER BY title ASC";
		 $sth = almyDb::$PDO->prepare($sql);
		 $sth->bindParam(':searchT', $search, PDO::PARAM_STR);
		 $sth->bindParam(':searchD', $search, PDO::PARAM_STR);
		 $sth->execute();
         return $sth->fetchAll();
      }
      public function getListeImage($cat = null) {
         $sql = "SELECT image.* FROM image ".(($cat == null)?"":"INNER JOIN catimg WHERE catimg.id_cat = :cat")." ORDER BY title ASC";
		 $sth = almyDb::$PDO->prepare($sql);
		 $sth->bindParam(':cat', $cat, PDO::PARAM_STR);
		 $sth->execute();
         return $sth->fetchAll();
      }
      public function addImage($link, $linkMin = null, $title = null, $descr = null) {
		 // $title = (($title == null)?"NULL":$title);
		 // $descr = (($descr == null)?"NULL":$descr);
		 // $link = (($link == null)?"NULL":$link);
		 // $linkMin = (($linkMin == null)?"NULL":$linkMin);
         $sql = "INSERT INTO image (id, title, descr, url, url_min) VALUES (NULL, :title ,:descr ,:link ,:linkmin);";
		 $sth = almyDb::$PDO->prepare($sql);
		 $sth->bindParam(':title', $title, PDO::PARAM_STR|PDO::PARAM_NULL );
		 $sth->bindParam(':descr', $descr, PDO::PARAM_STR|PDO::PARAM_NULL);
		 $sth->bindParam(':link', $link, PDO::PARAM_STR|PDO::PARAM_NULL);
		 $sth->bindParam(':linkmin', $linkMin, PDO::PARAM_STR|PDO::PARAM_NULL);
		 $sth->execute();
         if($sth->rowCount() == 1) {
            return true;
         }
         else {
            return false;
         }
      }
	  
		public function checkAllLink() {
			$list = $this->getListeImage();
			$count= 0;
			foreach($list as $image) {
				if(!file_exists($image['url'])) {
					if(file_exists($image['url_min']))
						unlink($image['url_min']);
					$this->deleteImage($image['id']);
					$count++;
				}
				else {
					if(!file_exists($image['url_min']))
						$this->updateImage($image['id'], array("url_min" => createMin($image['url'])));
				}
			}
			
			$dir = "upload";
			$dirOpen = opendir($dir) or die('Erreur');
			while($file = @readdir($dirOpen)) {
				if(!is_dir($dir.'/'.$file)&& $file != '.' && $file != '..') {
					$temp = $this->getImageByLink($dir.'/'.$file);
					if(!$temp && ($file!= "newFolder.txt")) {
						unlink($dir.'/'.$file);
					}
				}
			}
		    closedir($dirOpen);
			
			$dir = "upload/miniatures";
			$dirOpen = opendir($dir) or die('Erreur');
			while($file = @readdir($dirOpen)) {
				if(!is_dir($dir.'/'.$file)&& $file != '.' && $file != '..') {
					$temp = $this->getImageByLink($dir.'/'.$file);
					if(!$temp && ($file!= "newFolder.txt")) {
						unlink($dir.'/'.$file);
					}
				}
			}
		    closedir($dirOpen);
			
			return $count;
		}
		
      public function deleteImage($id) {
         $sql = "DELETE FROM image WHERE id = :id;";
         $sth = almyDb::$PDO->prepare($sql);
		 $sth->bindParam(':id', $id, PDO::PARAM_INT);
		 $sth->execute();
         if($sth->rowCount() == 1) {
            return true;
         }
         else {
            return false;
         }
      }
		public function updateImage($id, $arg) {
			$set = "";
			$count = 0;
			foreach ($arg as $field => $value) {
				if($count != 0)
					$set .= ", ";
				$set .= (($value == "NULL")?$field." = NULL":$field." = :".$field);
                $count++;
			}
			$sql = "UPDATE image SET ".$set." WHERE id = :id;";
			$sth = almyDb::$PDO->prepare($sql);
			$sth->bindParam(':id', $id, PDO::PARAM_STR);
			$count = 0;
			foreach ($arg as $field => $value) {
				$sth->bindParam(':'.$field, $value, PDO::PARAM_STR);
			}
			$sth->execute();
			
			if($sth->rowCount() == 1) {
				return true;
			}
			else {
				return false;
			}
		}
        function addCatImage($id_img, $id_cat) {
            $sql = "INSERT INTO catimg (id_img, id_cat) VALUES (:idImg, :idCat);";
			$sth = almyDb::$PDO->prepare($sql);
			$sth->bindParam(':idImg', $id_img, PDO::PARAM_INT);
			$sth->bindParam(':idCat', $id_cat, PDO::PARAM_INT);
			$sth->execute();
			if($sth->rowCount() == 1) {
				return true;
			}
			else {
				return false;
			}
                }
                
                function removeCatImage($id_img, $id_cat) {
                        $sql = "DELETE FROM catimg WHERE id_img = :idImg AND id_cat = :idCat;";
			$sth = almyDb::$PDO->prepare($sql);
			$sth->bindParam(':idImg', $id_img, PDO::PARAM_INT);
			$sth->bindParam(':idCat', $id_cat, PDO::PARAM_INT);
			$sth->execute();
			if($sth->rowCount() == 1) {
				return true;
			}
			else {
				return false;
			}
                }
        function removeAllCatImage($id_img) {
            $sql = "DELETE FROM catimg WHERE id_img = :idImg;";
			$sth = almyDb::$PDO->prepare($sql);
			$sth->bindParam(':idImg', $id_img, PDO::PARAM_INT);
			$sth->execute();
			if($sth->rowCount() != 0) {
				return true;
			}
			else {
				return false;
			}
        }
                
                
                /**
                 * Autre
                 */
                
      public function getUser($id = null) {

         $req  =  'SELECT * FROM user'.(($id != null)?' WHERE id=:id': '').' ORDER BY name;';
		 $sth = almyDb::$PDO->prepare($req);
		 $sth->bindParam(':id', $id, PDO::PARAM_INT);
		 $sth->execute();
		 
		 if($id == null)
			return $sth->fetchAll();
		 else
			return $sth->fetch();
      }
      public function updateUser($id, $args) {
		 $set = "";
		 foreach($args as $key => $val) {
			if($set !== "")
				$set .= ", ";
			$set .= $key."=:".$key."";
		 }
         $req  = 'UPDATE user SET '.$set.' WHERE id =:id';
		 $sth = almyDb::$PDO->prepare($req);
		 $sth->bindParam(':id', $id, PDO::PARAM_INT);
		 
		 foreach($args as $key => $val) {
			$sth->bindParam(':'.$key, $val, PDO::PARAM_STR);
		 }
		 $sth->execute();
         if($sth->rowCount() == 1) {
             return true;
         }
         else {
				 echo ($sth->rowCount()).$req;
            return false;
         }
      }
      public function traitementConnexion($login, $mdp) {

         $req  =  'SELECT * FROM user WHERE login=:login AND pass=:pass';
		 $sth = almyDb::$PDO->prepare($req);
		 $sth->bindParam(':login', $login, PDO::PARAM_STR);
		 $sth->bindParam(':pass', md5($mdp), PDO::PARAM_STR);
		 $sth->execute();

         if($sth->rowCount() == 1) {
             return $sth->fetch();
         }
         else {
            return false;
         }
        
      }
	}
?>